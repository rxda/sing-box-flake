name: Auto Update Sing-box
on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨 2 点执行
  workflow_dispatch:    # 允许手动触发

jobs:
  update-sing-box:
    runs-on: ubuntu-latest
    # ！！！权限声明：允许 Action 修改并推送代码到仓库 ！！！
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          # 开启实验性功能并消除你之前的 auto-allocate-uids 警告
          extra_nix_config: |
            experimental-features = nix-command flakes auto-allocate-uids configurable-impure-env
            auto-allocate-uids = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: rxda-cache # 替换为你的 Cachix 缓存名称
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Update Flake Inputs
        run: nix flake update sing-box-src

      - name: Auto Fix vendorHash
        run: |
          # 尝试构建，捕获哈希不匹配的错误
          set +e
          echo "Attempting initial build to check/fix vendorHash..."
          
          # 第一次运行，强制获取错误信息
          build_output=$(nix build .#default 2>&1)
          set -e

          # 从错误输出中提取 Nix 期望的 'got:' 后的正确哈希值
          new_hash=$(echo "$build_output" | grep "got:" | cut -d':' -f2 | xargs)

          if [ -n "$new_hash" ] && [ "$new_hash" != "null" ]; then
            echo "New vendorHash detected: $new_hash"
            # 使用 sed 搜索并替换 flake.nix 中的旧哈希
            sed -i "s|vendorHash = \"sha256-.*\";|vendorHash = \"$new_hash\";|g" flake.nix
          else
            echo "vendorHash is still valid or was already correct."
          fi

      - name: Final Build & Push to Cachix
        run: |
          # 实际构建，结果会自动上传到 Cachix
          # --print-build-logs 方便你在 Action 界面看编译进度
          nix build .#default --accept-flake-config --print-build-logs

      - name: Commit and Push changes
        run: |
          # 配置 Git 机器人身份
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 暂存所有更改
          git add flake.nix flake.lock
          
          # 检查是否有实际改动，避免 push 报错
          if git diff --cached --exit-code; then
            echo "No changes in flake.nix or flake.lock. Skipping push."
          else
            echo "Changes detected, pushing to repository..."
            git commit -m "chore: auto update sing-box and vendorHash"
            git push
          fi